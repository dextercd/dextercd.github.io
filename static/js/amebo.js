"use strict";window.GBMasterClass=function(){this.gameboys=[];const e=this.gameboys;function n(){for(const t of e)t.audioSyncUpdate();window.requestAnimationFrame(n)}window.requestAnimationFrame(n)},window.gb=function(file,canvas,options){if(options==null)var options={rootDir:""};this.options=options,typeof window.GBMaster>"u"&&(window.GBMaster=new window.GBMasterClass);var sadGB="data:image/gif;base64,R0lGODlhGQArAIAAAP///wAAACH5BAAHAP8ALAAAAAAZACsAAAKORI6pewYPo5yvGYZRDTf721Gi1mjiRHKmKrFhaTkolIYOF7m1eeawTaugfjwarkWM9Taq5pGpfDlzSGMTeMLtor2tJwNSUI5i2BcD6pwTmyG4ulxy43D6iPy0x+aj9iLuVdQSlFY4FrWXN1NnN9R493gY6Xg4JaSlKHdjqCfDl7X5CYqZqeck6IYKxUBRAAA7";this.RSToff=0,this.paused=!1,this.loadState=loadState,this.saveState=saveState;var GBObj=this;this.loadROM=function(e,n){var t=new XMLHttpRequest;t.open("GET",e),t.responseType="arraybuffer",t.send();var r=e.split("/");GBObj.filename=r[r.length-1],GBObj.paused=!0,t.onprogress=drawProgress,t.onreadystatechange=function(){this.mime=this.getResponseHeader("content-type")},t.onload=function(){GBObj.paused=n||!1,GBObj.loadROMBuffer(t.response)},t.onerror=function(){console.error("Failed to load "+e+"! Are CORS requests enabled on the server?")}},this.loadROMBuffer=function(e,n){e instanceof ArrayBuffer?game=new Uint8Array(e):e instanceof Uint8Array?game=e:console.error(e),GBObj.game=game,gameLoaded=!0,n!=null&&(ROMID=generateUniqueName(),CRAM=new Uint8Array(n),saveBattery()),init()};var internalCanvas=document.createElement("canvas");internalCanvas.width=160,internalCanvas.height=144,this.internalCanvas=internalCanvas;var internalCtx=internalCanvas.getContext("2d");canvas==null&&(canvas=internalCanvas),this.canvas=canvas;var ctx=canvas.getContext("2d");typeof ctx.webkitImageSmoothingEnabled<"u"?ctx.webkitImageSmoothingEnabled=!1:typeof ctx.imageSmoothingEnabled<"u"?ctx.imageSmoothingEnabled=!1:(console.log("imageSmoothingEnabled not supported, falling back to css scaling"),canvas.style.width=canvas.width+"px",canvas.style.height=canvas.height+"px",canvas.width=160,canvas.height=144),this.ctx=ctx;var colours=[[219,255,134,255],[194,226,33,255],[73,156,27,255],[15,86,47,255]];this.file=file;var gameLoaded=!1,GBAudioContext=null,getGamepads=navigator.webkitGamepads||navigator.webkitGetGamepads||navigator.getGamepads,p=navigator.platform,iOS=p==="iPad"||p==="iPhone"||p==="iPod";iOS&&setInterval(saveBattery,1e3);var NoAudioAPI=!1;typeof AudioContext<"u"?GBAudioContext=new AudioContext:typeof webkitAudioContext<"u"?GBAudioContext=new webkitAudioContext:NoAudioAPI=!0;var stereo=!0;NoAudioAPI&&(GBAudioContext={createGain:function(){return{gain:{value:0},connect:function(){}}},createChannelMerger:function(e){return{connect:function(){}}},createScriptProcessor:function(e,n,t){return{connect:function(){}}},sampleRate:0}),this.scopeEval=function(code){return eval(code)};var registers,flags,SP,PC,Cycles,IME,game,bios,CGBbios,MemRead,MemWrite,VRAM,RAM,OAM,IORAM,ZRAM,CRAM,biosActive,lineCycles,GBScreen,buttonByte,masterClock,frameskip,timeStart,sampleNumber,MBC,MBCReadHandler,MBCWriteHandler,AudioEngine,audioSampleRate,LCDstate,halted,palettes,palettesInt32,ROMID,WaveRAMCycles,CGB,CGBDMA,CPUSpeed,CGBBGPal,CGBBGPalReg,CGBSprPal,CGBSprPalReg,tileLayerData=new Uint8Array(160),tileLayerPalette=new Uint8Array(160),emptyTileLayer=new Uint8Array(160),bufferSize,audioSyncFrames,soundCycles,soundPhase,timerCycles,audioCycles,cyclesForSample,divCounts,CGBInt32BG,CGBInt32Spr,registerDebug,instCount;GBScreen=internalCtx.createImageData(160,144);var EmptyImageBuffer=new Uint8Array(GBScreen.data.length),GBScreenInt32=new Uint32Array(GBScreen.data.buffer),keyConfig={A:88,B:90,SELECT:32,START:13,UP:38,DOWN:40,LEFT:37,RIGHT:39};this.keyConfig=keyConfig;var controlKeyConfig={STATES:[112,113,114,115,116,117,118,119,120,121]};file!=null&&this.loadROM(file);for(var keysArray=new Array(256),i=0;i<256;i++)keysArray[i]=1;function keyDownHandler(e){keysArray[e.keyCode]=0;var n=controlKeyConfig.STATES.indexOf(e.keyCode);if(n!=-1)if(e.preventDefault(),keysArray[16]==0)localStorage["states/"+n]=JSON.stringify(saveState());else{var t=localStorage["states/"+n];typeof t<"u"&&loadState(JSON.parse(t))}}function keyUpHandler(e){keysArray[e.keyCode]=1}function getROMName(){for(var e="",n=308;n<=323&&game[n]!=0;n++)e+=String.fromCharCode(game[n]);return e}function generateUniqueName(){for(var e=0,n=0;n<game.length;n++)e=(e+game[n])%4294967295;for(var t="",n=308;n<=323;n++)t+=String.fromCharCode(game[n]);return t+e}var Instructions=[NOP,function(){LD16M(1)},function(){LDMA(1)},function(){INC16(1)},function(){INC(1)},function(){DEC(1)},function(){LDM(1)},function(){RLC(0),flags[0]=0},LDSP,function(){ADDHL16(1)},function(){LDAM(1)},function(){DEC16(1)},function(){INC(2)},function(){DEC(2)},function(){LDM(2)},function(){RRC(0),flags[0]=0},STOP,function(){LD16M(3)},function(){LDMA(3)},function(){INC16(3)},function(){INC(3)},function(){DEC(3)},function(){LDM(3)},function(){RL(0),flags[0]=0},function(){JR(4,1)},function(){ADDHL16(3)},function(){LDAM(3)},function(){DEC16(3)},function(){INC(4)},function(){DEC(4)},function(){LDM(4)},function(){RR(0),flags[0]=0},function(){JR(0,0)},function(){LD16M(5)},function(){LDMA(5),CHL(1)},function(){INC16(5)},function(){INC(5)},function(){DEC(5)},function(){LDM(5)},DAA,function(){JR(0,1)},function(){ADDHL16(5)},function(){LDAM(5),CHL(1)},function(){DEC16(5)},function(){INC(6)},function(){DEC(6)},function(){LDM(6)},CPL,function(){JR(3,0)},LDSPM,function(){LDMA(5),CHL(-1)},INCSP,INCHL,DECHL,LDHLM,SCF,function(){JR(3,1)},ADDHLSP,function(){LDAM(5),CHL(-1)},DECSP,function(){INC(0)},function(){DEC(0)},function(){LDM(0)},CCF,function(){LD(1,1)},function(){LD(1,2)},function(){LD(1,3)},function(){LD(1,4)},function(){LD(1,5)},function(){LD(1,6)},function(){LDFHL(1)},function(){LD(1,0)},function(){LD(2,1)},function(){LD(2,2)},function(){LD(2,3)},function(){LD(2,4)},function(){LD(2,5)},function(){LD(2,6)},function(){LDFHL(2)},function(){LD(2,0)},function(){LD(3,1)},function(){LD(3,2)},function(){LD(3,3)},function(){LD(3,4)},function(){LD(3,5)},function(){LD(3,6)},function(){LDFHL(3)},function(){LD(3,0)},function(){LD(4,1)},function(){LD(4,2)},function(){LD(4,3)},function(){LD(4,4)},function(){LD(4,5)},function(){LD(4,6)},function(){LDFHL(4)},function(){LD(4,0)},function(){LD(5,1)},function(){LD(5,2)},function(){LD(5,3)},function(){LD(5,4)},function(){LD(5,5)},function(){LD(5,6)},function(){LDFHL(5)},function(){LD(5,0)},function(){LD(6,1)},function(){LD(6,2)},function(){LD(6,3)},function(){LD(6,4)},function(){LD(6,5)},function(){LD(6,6)},function(){LDFHL(6)},function(){LD(6,0)},function(){LDTHL(1)},function(){LDTHL(2)},function(){LDTHL(3)},function(){LDTHL(4)},function(){LDTHL(5)},function(){LDTHL(6)},HALT,function(){LDTHL(0)},function(){LD(0,1)},function(){LD(0,2)},function(){LD(0,3)},function(){LD(0,4)},function(){LD(0,5)},function(){LD(0,6)},function(){LDFHL(0)},function(){LD(0,0)},function(){ADD(1)},function(){ADD(2)},function(){ADD(3)},function(){ADD(4)},function(){ADD(5)},function(){ADD(6)},ADDHL,function(){ADD(0)},function(){ADC(1)},function(){ADC(2)},function(){ADC(3)},function(){ADC(4)},function(){ADC(5)},function(){ADC(6)},ADCHL,function(){ADC(0)},function(){SUB(1)},function(){SUB(2)},function(){SUB(3)},function(){SUB(4)},function(){SUB(5)},function(){SUB(6)},SUBHL,function(){SUB(0)},function(){SBC(1)},function(){SBC(2)},function(){SBC(3)},function(){SBC(4)},function(){SBC(5)},function(){SBC(6)},SBCHL,function(){SBC(0)},function(){AND(1)},function(){AND(2)},function(){AND(3)},function(){AND(4)},function(){AND(5)},function(){AND(6)},ANDHL,function(){AND(0)},function(){XOR(1)},function(){XOR(2)},function(){XOR(3)},function(){XOR(4)},function(){XOR(5)},function(){XOR(6)},XORHL,function(){XOR(0)},function(){OR(1)},function(){OR(2)},function(){OR(3)},function(){OR(4)},function(){OR(5)},function(){OR(6)},ORHL,function(){OR(0)},function(){CP(1)},function(){CP(2)},function(){CP(3)},function(){CP(4)},function(){CP(5)},function(){CP(6)},CPHL,function(){CP(0)},function(){RET(0,0)},function(){POP(1)},function(){JP(0,0)},function(){JP(4,1)},function(){CALL(0,0)},function(){PUSH(1)},ADDM,function(){RST(0)},function(){RET(0,1)},NRET,function(){JP(0,1)},PrefixCB,function(){CALL(0,1)},function(){CALL(4,1)},ADCM,function(){RST(8)},function(){RET(3,0)},function(){POP(3)},function(){JP(3,0)},UNIMP,function(){CALL(3,0)},function(){PUSH(3)},SUBM,function(){RST(16)},function(){RET(3,1)},function(){EI(),NRET()},function(){JP(3,1)},UNIMP,function(){CALL(3,1)},UNIMP,SBCM,function(){RST(24)},LDH_M_A,function(){POP(5)},LDH_C_A,UNIMP,UNIMP,function(){PUSH(5)},ANDM,function(){RST(32)},ADDSP,JPHL,LD_M_A,UNIMP,UNIMP,UNIMP,XORM,function(){RST(40)},LDH_A_M,POPAF,LDH_A_C,DI,UNIMP,PUSHAF,ORM,function(){RST(48)},LD_HL_SPM,LDSPHL,LD_A_M,EI,UNIMP,UNIMP,CPM,function(){RST(56)}],PrefixCBI=[function(){RLC(1)},function(){RLC(2)},function(){RLC(3)},function(){RLC(4)},function(){RLC(5)},function(){RLC(6)},RLCHL,function(){RLC(0)},function(){RRC(1)},function(){RRC(2)},function(){RRC(3)},function(){RRC(4)},function(){RRC(5)},function(){RRC(6)},RRCHL,function(){RRC(0)},function(){RL(1)},function(){RL(2)},function(){RL(3)},function(){RL(4)},function(){RL(5)},function(){RL(6)},RLHL,function(){RL(0)},function(){RR(1)},function(){RR(2)},function(){RR(3)},function(){RR(4)},function(){RR(5)},function(){RR(6)},RRHL,function(){RR(0)},function(){SLA(1)},function(){SLA(2)},function(){SLA(3)},function(){SLA(4)},function(){SLA(5)},function(){SLA(6)},SLAHL,function(){SLA(0)},function(){SRA(1)},function(){SRA(2)},function(){SRA(3)},function(){SRA(4)},function(){SRA(5)},function(){SRA(6)},SRAHL,function(){SRA(0)},function(){SWAP(1)},function(){SWAP(2)},function(){SWAP(3)},function(){SWAP(4)},function(){SWAP(5)},function(){SWAP(6)},SWAPHL,function(){SWAP(0)},function(){SRL(1)},function(){SRL(2)},function(){SRL(3)},function(){SRL(4)},function(){SRL(5)},function(){SRL(6)},SRLHL,function(){SRL(0)},function(){BIT(0,1)},function(){BIT(0,2)},function(){BIT(0,3)},function(){BIT(0,4)},function(){BIT(0,5)},function(){BIT(0,6)},function(){BITHL(0)},function(){BIT(0,0)},function(){BIT(1,1)},function(){BIT(1,2)},function(){BIT(1,3)},function(){BIT(1,4)},function(){BIT(1,5)},function(){BIT(1,6)},function(){BITHL(1)},function(){BIT(1,0)},function(){BIT(2,1)},function(){BIT(2,2)},function(){BIT(2,3)},function(){BIT(2,4)},function(){BIT(2,5)},function(){BIT(2,6)},function(){BITHL(2)},function(){BIT(2,0)},function(){BIT(3,1)},function(){BIT(3,2)},function(){BIT(3,3)},function(){BIT(3,4)},function(){BIT(3,5)},function(){BIT(3,6)},function(){BITHL(3)},function(){BIT(3,0)},function(){BIT(4,1)},function(){BIT(4,2)},function(){BIT(4,3)},function(){BIT(4,4)},function(){BIT(4,5)},function(){BIT(4,6)},function(){BITHL(4)},function(){BIT(4,0)},function(){BIT(5,1)},function(){BIT(5,2)},function(){BIT(5,3)},function(){BIT(5,4)},function(){BIT(5,5)},function(){BIT(5,6)},function(){BITHL(5)},function(){BIT(5,0)},function(){BIT(6,1)},function(){BIT(6,2)},function(){BIT(6,3)},function(){BIT(6,4)},function(){BIT(6,5)},function(){BIT(6,6)},function(){BITHL(6)},function(){BIT(6,0)},function(){BIT(7,1)},function(){BIT(7,2)},function(){BIT(7,3)},function(){BIT(7,4)},function(){BIT(7,5)},function(){BIT(7,6)},function(){BITHL(7)},function(){BIT(7,0)},function(){RES(0,1)},function(){RES(0,2)},function(){RES(0,3)},function(){RES(0,4)},function(){RES(0,5)},function(){RES(0,6)},function(){RESHL(0)},function(){RES(0,0)},function(){RES(1,1)},function(){RES(1,2)},function(){RES(1,3)},function(){RES(1,4)},function(){RES(1,5)},function(){RES(1,6)},function(){RESHL(1)},function(){RES(1,0)},function(){RES(2,1)},function(){RES(2,2)},function(){RES(2,3)},function(){RES(2,4)},function(){RES(2,5)},function(){RES(2,6)},function(){RESHL(2)},function(){RES(2,0)},function(){RES(3,1)},function(){RES(3,2)},function(){RES(3,3)},function(){RES(3,4)},function(){RES(3,5)},function(){RES(3,6)},function(){RESHL(3)},function(){RES(3,0)},function(){RES(4,1)},function(){RES(4,2)},function(){RES(4,3)},function(){RES(4,4)},function(){RES(4,5)},function(){RES(4,6)},function(){RESHL(4)},function(){RES(4,0)},function(){RES(5,1)},function(){RES(5,2)},function(){RES(5,3)},function(){RES(5,4)},function(){RES(5,5)},function(){RES(5,6)},function(){RESHL(5)},function(){RES(5,0)},function(){RES(6,1)},function(){RES(6,2)},function(){RES(6,3)},function(){RES(6,4)},function(){RES(6,5)},function(){RES(6,6)},function(){RESHL(6)},function(){RES(6,0)},function(){RES(7,1)},function(){RES(7,2)},function(){RES(7,3)},function(){RES(7,4)},function(){RES(7,5)},function(){RES(7,6)},function(){RESHL(7)},function(){RES(7,0)},function(){SET(0,1)},function(){SET(0,2)},function(){SET(0,3)},function(){SET(0,4)},function(){SET(0,5)},function(){SET(0,6)},function(){SETHL(0)},function(){SET(0,0)},function(){SET(1,1)},function(){SET(1,2)},function(){SET(1,3)},function(){SET(1,4)},function(){SET(1,5)},function(){SET(1,6)},function(){SETHL(1)},function(){SET(1,0)},function(){SET(2,1)},function(){SET(2,2)},function(){SET(2,3)},function(){SET(2,4)},function(){SET(2,5)},function(){SET(2,6)},function(){SETHL(2)},function(){SET(2,0)},function(){SET(3,1)},function(){SET(3,2)},function(){SET(3,3)},function(){SET(3,4)},function(){SET(3,5)},function(){SET(3,6)},function(){SETHL(3)},function(){SET(3,0)},function(){SET(4,1)},function(){SET(4,2)},function(){SET(4,3)},function(){SET(4,4)},function(){SET(4,5)},function(){SET(4,6)},function(){SETHL(4)},function(){SET(4,0)},function(){SET(5,1)},function(){SET(5,2)},function(){SET(5,3)},function(){SET(5,4)},function(){SET(5,5)},function(){SET(5,6)},function(){SETHL(5)},function(){SET(5,0)},function(){SET(6,1)},function(){SET(6,2)},function(){SET(6,3)},function(){SET(6,4)},function(){SET(6,5)},function(){SET(6,6)},function(){SETHL(6)},function(){SET(6,0)},function(){SET(7,1)},function(){SET(7,2)},function(){SET(7,3)},function(){SET(7,4)},function(){SET(7,5)},function(){SET(7,6)},function(){SETHL(7)},function(){SET(7,0)}];function byteToString(e,n){if(!(typeof e>"u")){for(var t="",r=0;r<e.length;r++)t+=String.fromCharCode(e[r]);return n?t:btoa(t)}}function stringToByte(t,n){var t=n?t:atob(t);if(!(typeof t>"u")){for(var r=new Uint8Array(t.length),s=0;s<r.length;s++)r[s]=t.charCodeAt(s);return r}}function saveState(){return{VRAM:byteToString(VRAM),RAM:byteToString(RAM),OAM:byteToString(OAM),IORAM:byteToString(IORAM),ZRAM:byteToString(ZRAM),CRAM:byteToString(CRAM)||"",CGBDMA,CGBBGPalReg:byteToString(CGBBGPalReg)||"",CGBSprPalReg:byteToString(CGBSprPalReg)||"",CPUSpeed,MBC,registers:byteToString(registers),flags,SP,PC,biosActive,IME,LCDstate,CycleTimers:{masterClock,lineCycles,soundCycles,soundPhase,timerCycles,audioCycles,divCounts},AudioEngine:objectifyAudioEngine()}}function loadState(e){VRAM=stringToByte(e.VRAM),RAM=stringToByte(e.RAM),OAM=stringToByte(e.OAM),IORAM=stringToByte(e.IORAM),ZRAM=stringToByte(e.ZRAM),CRAM=stringToByte(e.CRAM),CGB&&(CGBDMA=e.CGBDMA,CGBBGPalReg=stringToByte(e.CGBBGPalReg),CGBSprPalReg=stringToByte(e.CGBSprPalReg),CPUSpeed=e.CPUSpeed,restorePal(CGBBGPalReg,CGBBGPal),restorePal(CGBSprPalReg,CGBSprPal)),MBC=e.MBC,registers=stringToByte(e.registers),flags=e.flags,SP=e.SP,PC=e.PC,biosActive=e.biosActive,IME=e.IME,LCDstate=e.LCDstate,masterClock=e.CycleTimers.masterClock,lineCycles=e.CycleTimers.lineCycles,soundCycles=e.CycleTimers.soundCycles,soundPhase=e.CycleTimers.soundPhase,timerCycles=e.CycleTimers.timerCycles,audioCycles=e.CycleTimers.audioCycles,divCounts=e.CycleTimers.divCounts,restoreAudioEngine(e.AudioEngine),audioSyncFrames=0,cyclesForSample=4194304*CPUSpeed/audioSampleRate,palettes.set(readDMGPalette(0),0),palettes.set(readDMGPalette(1),16),palettes.set(readDMGPalette(2),32)}function restorePal(e,n){for(var t=0;t<32;t++){var r=8.225806451612904;n.set([Math.round((e[t*2]&31)*r),Math.round(((e[t*2]>>5)+((e[t*2+1]&3)<<3))*r),Math.round(((e[t*2+1]&124)>>2)*r),255],t*4)}}function objectifyAudioEngine(){var e={};if(typeof AudioEngine>"u")return null;for(var n=0;n<4;n++)e[n]={frequency:AudioEngine[n].frequency,duty:AudioEngine[n].duty,phase:AudioEngine[n].phase,volume:AudioEngine[n].volume,lEnable:AudioEngine[n].lEnable,rEnable:AudioEngine[n].rEnable,esweep:AudioEngine[n].esweep,freqreg:AudioEngine[n].freqreg,fsweep:AudioEngine[n].fsweep,lengthCtr:AudioEngine[n].lengthCtr,volreg:AudioEngine[n].volreg,sampleNumber:AudioEngine[n].sampleNumber};return e[3].LFSR=AudioEngine[3].LFSR,e[3].frequency=AudioEngine[3].frequency,e.lVolume=AudioEngine.lVolume,e.rVolume=AudioEngine.rVolume,e.avgVol=AudioEngine.avgVol,e}function restoreAudioEngine(e){for(var n=0;n<4;n++)AudioEngine[n].frequency=e[n].frequency,AudioEngine[n].duty=e[n].duty,AudioEngine[n].phase=e[n].phase,AudioEngine[n].volume=e[n].volume,AudioEngine[n].lEnable=e[n].lEnable,AudioEngine[n].rEnable=e[n].rEnable,AudioEngine[n].esweep=e[n].esweep,AudioEngine[n].freqreg=e[n].freqreg,AudioEngine[n].fsweep=e[n].fsweep,AudioEngine[n].lengthCtr=e[n].lengthCtr,AudioEngine[n].volreg=e[n].volreg,AudioEngine[n].sampleNumber=e[n].sampleNumber;AudioEngine[3].LFSR=e[3].LFSR,AudioEngine[3].frequency=e[3].frequency,AudioEngine.lVolume=e.lVolume,AudioEngine.rVolume=e.rVolume,AudioEngine.avgVol=e.avgVol}var IOReadFunctions=[],IOWriteFunctions=[];IOWriteFunctions[4]=function(e,n){IORAM[n]=0},IOWriteFunctions[7]=function(e,n){IORAM[n]=e},IOReadFunctions[5]=function(e){return IORAM[e]},IOWriteFunctions[67]=function(e,n){IORAM[n]=e},IOWriteFunctions[64]=function(e,n){(IORAM[64]&128)!=(e&128)&&(e&128&&(IORAM[68]=0,lineCycles=0,LCDstate=2,IORAM[68]==IORAM[69]&&handleScanCoin()),IORAM[15]&=253),IORAM[n]=e},IOWriteFunctions[68]=function(e,n){console.log("writing to LCDY??? what are you even doing")},IOWriteFunctions[69]=function(e,n){IORAM[n]!=e&&IORAM[64]&128&&IORAM[68]==e&&handleScanCoin(),IORAM[n]=e},IOWriteFunctions[65]=function(e,n){IORAM[n]=IORAM[n]&7|e&120},IOReadFunctions[65]=function(e){return IORAM[e]&252|IORAM[64]&128?LCDstate:0},IOWriteFunctions[77]=function(e,n){IORAM[n]=e},IOReadFunctions[77]=function(e){return CGB?IORAM[e]&1|(CPUSpeed==2?128:0):IORAM[e]},IOWriteFunctions[81]=function(e){CGBDMA.srcPos=(e<<8|CGBDMA.srcPos&255)&65520},IOWriteFunctions[82]=function(e){CGBDMA.srcPos=(e|CGBDMA.srcPos&65280)&65520},IOWriteFunctions[83]=function(e){CGBDMA.destPos=(e<<8|CGBDMA.destPos&255)&8176},IOWriteFunctions[84]=function(e){CGBDMA.destPos=(e|CGBDMA.destPos&65280)&8176},IOReadFunctions[81]=function(e){return CGBDMA.srcPos>>8},IOReadFunctions[82]=function(e){return CGBDMA.srcPos&255},IOReadFunctions[83]=function(e){return CGBDMA.destPos>>8},IOReadFunctions[84]=function(e){return CGBDMA.destPos&255},IOWriteFunctions[85]=function(e,n){if(CGB){if(CGBDMA.active&&CGBDMA.mode&&!(e&128)){CGBDMA.active=!1;return}CGBDMA.active=!0,CGBDMA.mode=e&128,CGBDMA.Tlength=(e&127)+1<<4,IORAM[n]=e}else IORAM[n]=e},IOReadFunctions[85]=function(e){return CGB?CGBDMA.active?(CGBDMA.Tlength>>4)-1|128:0:IORAM[e]},IOWriteFunctions[79]=function(e,n){CGB?IORAM[n]=e&1:IORAM[n]=e},IOWriteFunctions[112]=function(e,n){CGB?e&7?IORAM[n]=e&7:IORAM[n]=1:IORAM[n]=e},IOReadFunctions[105]=function(e){return CGB?CGBBGPalReg[IORAM[104]&63]:IORAM[e]},IOWriteFunctions[105]=function(e,n){if(CGB){var t=IORAM[104]&63;CGBBGPalReg[t]=e;var r=Math.floor(t/2),s=8.225806451612904;CGBBGPal.set([Math.round((CGBBGPalReg[r*2]&31)*s),Math.round(((CGBBGPalReg[r*2]>>5)+((CGBBGPalReg[r*2+1]&3)<<3))*s),Math.round(((CGBBGPalReg[r*2+1]&124)>>2)*s),255],r*4),IORAM[104]&128&&(IORAM[104]=IORAM[104]+1&63|128)}else IORAM[n]=e},IOReadFunctions[107]=function(e){return CGB?CGBSprPalReg[IORAM[106]&63]:IORAM[e]},IOWriteFunctions[107]=function(e,n){if(CGB){var t=IORAM[106]&63;CGBSprPalReg[t]=e;var r=Math.floor(t/2),s=8.225806451612904;CGBSprPal.set([Math.round((CGBSprPalReg[r*2]&31)*s),Math.round(((CGBSprPalReg[r*2]>>5)+((CGBSprPalReg[r*2+1]&3)<<3))*s),Math.round(((CGBSprPalReg[r*2+1]&124)>>2)*s),255],r*4),IORAM[106]&128&&(IORAM[106]=IORAM[106]+1&63|128)}else IORAM[n]=e},IOWriteFunctions[80]=function(e,n){biosActive=!1,IORAM[n]=e},IOWriteFunctions[70]=function(e,n){DMATransfer(e)},IOWriteFunctions[0]=function(e,n){e=255-e,e&16?IORAM[0]=buttonByte&15:e&32&&(IORAM[0]=buttonByte>>4)},IOWriteFunctions[16]=function(e,n){IORAM[38]&128&&(IORAM[n]=e)},IOWriteFunctions[17]=function(e,n){if(IORAM[38]&128)IORAM[n]=e,AudioEngine[0].duty=duties[e>>6];else if(CGB)return;AudioEngine[0].lengthCtr=64-(e&63)},IOWriteFunctions[18]=function(e,n){if(IORAM[38]&128){var t=IORAM[esweepPtrs[0]];if(IORAM[38]&1)var r=t&7;IORAM[n]=e,e&248||channelOff(0),soundPhase=1}},IOWriteFunctions[19]=function(e,n){IORAM[38]&128&&(IORAM[n]=e,setChannelFrequency(0))},IOWriteFunctions[20]=function(e,n){if(IORAM[38]&128){var t=!(IORAM[20]&64)&&e&64;t&&(soundPhase&1)==1&&AudioEngine[0].lengthCtr!=0&&--AudioEngine[0].lengthCtr==0&&channelOff(0),IORAM[n]=e,e>>7==1?triggerChannel(0):setChannelFrequency(0)}},IOWriteFunctions[21]=function(e,n){IORAM[38]&128&&(IORAM[n]=e)},IOWriteFunctions[22]=function(e,n){if(IORAM[38]&128)IORAM[n]=e,AudioEngine[1].duty=duties[e>>6];else if(CGB)return;AudioEngine[1].lengthCtr=64-(e&63)},IOWriteFunctions[23]=function(e,n){if(IORAM[38]&128){var t=IORAM[esweepPtrs[1]];if(IORAM[38]&2)var r=t&7;IORAM[n]=e,e&248||channelOff(1)}},IOWriteFunctions[24]=function(e,n){IORAM[38]&128&&(IORAM[n]=e,setChannelFrequency(1))},IOWriteFunctions[25]=function(e,n){if(IORAM[38]&128){var t=!(IORAM[25]&64)&&e&64;t&&(soundPhase&1)==1&&AudioEngine[1].lengthCtr!=0&&--AudioEngine[1].lengthCtr==0&&channelOff(1),IORAM[n]=e,e>>7==1?triggerChannel(1):setChannelFrequency(1)}},IOWriteFunctions[26]=function(e,n){IORAM[38]&128&&(IORAM[n]=e,e&128||channelOff(2))},IOWriteFunctions[27]=function(e,n){if(IORAM[38]&128)IORAM[n]=e;else if(CGB)return;AudioEngine[2].lengthCtr=256-e},IOWriteFunctions[28]=function(e,n){IORAM[38]&128&&(IORAM[n]=e,readAndUpdateVolume(2))},IOWriteFunctions[29]=function(e,n){IORAM[38]&128&&(IORAM[n]=e,setChannelFrequency(2))},IOWriteFunctions[30]=function(e,n){if(IORAM[38]&128){var t=!(IORAM[30]&64)&&e&64;t&&(soundPhase&1)==1&&AudioEngine[2].lengthCtr!=0&&--AudioEngine[2].lengthCtr==0&&channelOff(2),IORAM[n]=e,e>>7==1?triggerChannel(2):setChannelFrequency(2)}},IOWriteFunctions[31]=function(e,n){IORAM[38]&128&&(IORAM[n]=e)},IOWriteFunctions[32]=function(e,n){if(IORAM[38]&128)IORAM[n]=e;else if(CGB)return;AudioEngine[3].lengthCtr=64-(e&63)},IOWriteFunctions[33]=function(e,n){if(IORAM[38]&128){var t=IORAM[esweepPtrs[3]];if(IORAM[38]&8)var r=t&7;IORAM[n]=e,e&248||channelOff(3)}},IOWriteFunctions[34]=function(e,n){IORAM[38]&128&&(IORAM[n]=e,updateNoiseFrequency())},IOWriteFunctions[35]=function(e,n){if(IORAM[38]&128){var t=!(IORAM[35]&64)&&e&64;t&&(soundPhase&1)==1&&AudioEngine[3].lengthCtr!=0&&--AudioEngine[3].lengthCtr==0&&channelOff(3),IORAM[n]=e,e>>7==1?triggerChannel(3):updateNoiseFrequency()}},IOWriteFunctions[36]=function(e,n){IORAM[38]&128&&(IORAM[n]=e,soundMasterGain())},IOWriteFunctions[37]=function(e,n){if(IORAM[38]&128){IORAM[n]=e;for(var t=0;t<4;t++)AudioEngine[t].lEnable=e&1<<t+4,AudioEngine[t].rEnable=e&1<<t}},IOWriteFunctions[38]=function(e,n){if(IORAM[38]&128&&!(e&128)){for(var t=0;t<4;t++)channelOff(t);for(var t=16;t<38;t++)(lengthPtrs.indexOf(t)==-1||CGB)&&IOWriteFunctions[t](0,t);IORAM[n]=0}else!(IORAM[38]&128)&&e&128&&(IORAM[n]=128)},IOReadFunctions[16]=function(e){return IORAM[e]|128},IOReadFunctions[17]=function(e){return IORAM[e]|63},IOReadFunctions[19]=function(e){return IORAM[e]|255},IOReadFunctions[20]=function(e){return IORAM[e]|191},IOReadFunctions[21]=function(e){return IORAM[e]|255},IOReadFunctions[22]=function(e){return IORAM[e]|63},IOReadFunctions[24]=function(e){return IORAM[e]|255},IOReadFunctions[25]=function(e){return IORAM[e]|191},IOReadFunctions[26]=function(e){return IORAM[e]|127},IOReadFunctions[27]=function(e){return IORAM[e]|255},IOReadFunctions[28]=function(e){return IORAM[e]|159},IOReadFunctions[29]=function(e){return IORAM[e]|255},IOReadFunctions[30]=function(e){return IORAM[e]|191},IOReadFunctions[31]=function(e){return IORAM[e]|255},IOReadFunctions[32]=function(e){return IORAM[e]|255},IOReadFunctions[35]=function(e){return IORAM[e]|191},IOReadFunctions[38]=function(e){return IORAM[e]|112},IOWriteFunctions[71]=function(e,n){IORAM[n]=e,palettes.set(readDMGPalette(0),0)},IOWriteFunctions[72]=function(e,n){IORAM[n]=e,palettes.set(readDMGPalette(1),16)},IOWriteFunctions[73]=function(e,n){IORAM[n]=e,palettes.set(readDMGPalette(2),32)};function calculateCurrentWaveRam(){var e=(AudioEngine[2].phase+AudioEngine[2].frequency*(audioSampleRate/4194304)*(masterClock-WaveRAMCycles))%32;return Math.floor(e/2)}function WaveRAMRead(e){return IORAM[38]&4?IORAM[48+calculateCurrentWaveRam()]:IORAM[e]}function WaveRAMWrite(e,n){IORAM[38]&4?(console.log("illegal WRAM change!"),IORAM[48+Math.floor(AudioEngine[2].phase/2)]=e):IORAM[n]=e}for(var i=39;i<=47;i++)IOReadFunctions[i]=function(n){return 255};for(var i=48;i<=63;i++)IOReadFunctions[i]=WaveRAMRead,IOWriteFunctions[i]=WaveRAMWrite;var IOWriteDefault=function(e,n){IORAM[n]=e},IOReadDefault=function(e){return IORAM[e]};function DMATransfer(e){for(var n=e<<8,t=0;t<159;t++)OAM[t]=MemRead(n++),Cycles-=4}function bufferCopyNode(e){var n=e.currentTarget,t=e.outputBuffer.getChannelData(0),r=n.bufferRead;if(t.set(n.buffers[r]),n.buffers[r].set(AudioEngine.emptyBuffer),stereo){var t=e.outputBuffer.getChannelData(1);t.set(n.buffersR[r]),n.buffersR[r].set(AudioEngine.emptyBuffer)}n.bufferRead=(r+1)%AudioEngine.buffers,GBObj.paused||(audioSyncFrames+=bufferSize/audioSampleRate/(70224/4194304))}function noiseNode(e){var n=AudioEngine[e],t=n.LFSR;for((n.lEnable||n.rEnable)&&handleStereo((1-(t&1)-.5)*n.volume,n),n.phase++;n.phase>n.frequency;){var r=t&1^t>>1&1;t=(r<<14)+(t>>1),n.phase-=n.frequency}n.LFSR=t}function squareWaveNode(e){var n=AudioEngine[e];(n.lEnable||n.rEnable)&&(n.phase<n.frequency*n.duty?handleStereo(n.volume/2,n):handleStereo(0-n.volume/2,n)),n.phase=(n.phase+1)%n.frequency}function waveNode(e){var n=AudioEngine[e];if(n.lEnable||n.rEnable){var t=Math.floor(n.phase),r=IORAM[48+Math.floor(t/2)]>>4*(1-t%2)&15;handleStereo((r/15-.5)*n.volume,n)}WaveRAMCycles=masterClock,n.phase=(n.phase+n.frequency)%32}function handleStereo(e,n){var t=AudioEngine.out,r=t.bufferPos;stereo?(t.curBuf[r]+=n.lEnable?e*AudioEngine.lVolume:0,t.curBufR[r]+=n.rEnable?e*AudioEngine.rVolume:0):t.curBuf[r]+=e*AudioEngine.avgVol}function advanceBufWrite(e){e.bufferPos=0;var n=e.bufferWrite;e.buffers[n].set(e.curBuf),e.curBuf.set(AudioEngine.emptyBuffer),stereo&&(e.buffersR[n].set(e.curBufR),e.curBufR.set(AudioEngine.emptyBuffer)),e.bufferWrite=(e.bufferWrite+1)%AudioEngine.buffers,e.bufferWrite==e.bufferRead&&(e.bufferWrite=n)}function checkDACPower(e){switch(e){case 0:return IORAM[18]&248;case 1:return IORAM[23]&248;case 2:return IORAM[26]&128;case 3:return IORAM[33]&248}}function prepareAudioEngine(){var e=typeof AudioEngine>"u";if(e)for(AudioEngine=[],sampleNumber=0,audioSampleRate=GBAudioContext.sampleRate,bufferSize=1024;bufferSize/audioSampleRate<.016;)bufferSize*=2;GBAudioContext.createScriptProcessor=GBAudioContext.createScriptProcessor||GBAudioContext.createJavaScriptNode;var n=4;AudioEngine.buffers=n,e&&(AudioEngine.out=GBAudioContext.createScriptProcessor(bufferSize,0,stereo?2:1),AudioEngine.out.connect(GBAudioContext.destination)),AudioEngine.out.buffers=new Array(n),stereo&&(AudioEngine.out.buffersR=new Array(n));for(var t=0;t<n;t++)AudioEngine.out.buffers[t]=new Float32Array(bufferSize),stereo&&(AudioEngine.out.buffersR[t]=new Float32Array(bufferSize));AudioEngine.out.curBuf=new Float32Array(bufferSize),stereo&&(AudioEngine.out.curBufR=new Float32Array(bufferSize)),AudioEngine.out.bufferPos=0,AudioEngine.out.bufferRead=0,AudioEngine.out.bufferWrite=n-1,AudioEngine.out.onaudioprocess=bufferCopyNode;for(var r=0;r<4;r++)AudioEngine[r]={},AudioEngine[r].lEnable=!1,AudioEngine[r].rEnable=!1,AudioEngine[r].frequency=0,AudioEngine[r].duty=.5,AudioEngine[r].phase=0,AudioEngine[r].volume=0,AudioEngine[r].sampleNumber=0,AudioEngine[r].lengthCtr=0;AudioEngine[3].LFSR=32767,AudioEngine[3].frequency=4194304/8,AudioEngine.emptyBuffer=new Float32Array(bufferSize),AudioEngine.lVolume=0,AudioEngine.rVolume=0,AudioEngine.avgVol=0}var duties=[.125,.25,.5,.75],freqDivisors=[1/2,1,2,3,4,5,6,7],esweepPtrs=[18,23,0,33];function handleLengths(){clockLength(0),clockLength(1),clockLength(2),clockLength(3)}function clockLength(e){IORAM[lengthPtrs[e]]&64&&--AudioEngine[e].lengthCtr==0&&channelOff(e)}function handleSweep(){if(AudioEngine[0].fSweepEnabled){var e=IORAM[16]>>4&7;e>0?--AudioEngine[0].fsweep<=0&&(AudioEngine[0].fsweep=e,calculateSweep(!0),calculateSweep(!1)):--AudioEngine[0].fsweep<=0&&(AudioEngine[0].fsweep=8)}}function calculateSweep(e){var n=IORAM[16]&7;if(!e)var t=AudioEngine[0].freqreg;var r=AudioEngine[0].freqreg>>n;AudioEngine[0].freqreg+=IORAM[16]&8?-r:r,AudioEngine[0].freqreg<0&&(AudioEngine[0].freqreg=0),AudioEngine[0].freqreg>2047&&(AudioEngine[0].freqreg=2047,channelOff(0)),e?(AudioEngine[0].frequency=audioSampleRate/(524288/((2048-AudioEngine[0].freqreg)*4)),IORAM[19]=AudioEngine[0].freqreg&255,IORAM[20]&=248,IORAM[20]|=AudioEngine[0].freqreg>>8):AudioEngine[0].freqreg=t}function envelopeTick(e){if(IORAM[38]&1<<e){var n=IORAM[esweepPtrs[e]],t=n&7;if(t>0){if(--AudioEngine[e].esweep<=0){AudioEngine[e].esweep=t;var r=AudioEngine[e].volreg;n&8?r++:r--,r<0&&(r=0),r>15&&(r=15),AudioEngine[e].volreg=r,setVolumeChannel(e,r/15)}}else--AudioEngine[e].esweep<=0&&(AudioEngine[e].esweep=8)}}function handleEnvelope(){envelopeTick(0),envelopeTick(1),envelopeTick(3)}function updateNoiseFrequency(){AudioEngine[3].frequency=audioSampleRate/(4194304/8/freqDivisors[IORAM[34]&7]>>(IORAM[34]>>4)+1)}function soundMasterGain(){IORAM[38]>>7==1?(AudioEngine.lVolume=(IORAM[36]>>4&7)/7,AudioEngine.rVolume=(IORAM[36]&7)/7,AudioEngine.avgVol=(AudioEngine.lVolume+AudioEngine.rVolume)/2):(AudioEngine.lVolume=0,AudioEngine.rVolume=0,AudioEngine.avgVol=0)}function setVolumeChannel(e,n){IORAM[38]&1<<e?AudioEngine[e].volume=n/4:AudioEngine[e].volume=0}var lengthPtrs=[20,25,30,35];function triggerChannel(e){if(0&&e==2&&IORAM[38]&4)var n;e<3?(setChannelFrequency(e),AudioEngine[e].phase=0):AudioEngine[e].LFSR=32767,checkDACPower(e)&&(IORAM[38]|=1<<e),readAndUpdateVolume(e);var t;if(AudioEngine[e].lengthCtr==0&&(e==2?AudioEngine[e].lengthCtr=256:AudioEngine[e].lengthCtr=64,IORAM[lengthPtrs[e]]&64&&(soundPhase&1)==1&&(AudioEngine[e].lengthCtr-=1)),AudioEngine[e].esweep=0,e==0){var r=IORAM[16]>>4&7,s=IORAM[16]&7;AudioEngine[0].fsweep=r==0?8:r,AudioEngine[0].fSweepEnabled=r+s>0,AudioEngine[0].freqreg=IORAM[19]+((IORAM[20]&7)<<8),IORAM[16]&7&&calculateSweep(!1)}return t}function channelOff(e){IORAM[38]&=255-(1<<e),setVolumeChannel(e,0)}function readAndUpdateVolume(e){switch(e){case 0:var n=(IORAM[18]>>4)/15;break;case 1:var n=(IORAM[23]>>4)/15;break;case 2:switch(IORAM[28]>>5&3){case 0:var n=0;break;case 1:var n=1;break;case 2:var n=.5;break;case 3:var n=.25;break}break;case 3:var n=(IORAM[33]>>4)/15;break}AudioEngine[e].volreg=Math.round(n*15),setVolumeChannel(e,n)}function setChannelFrequency(e){switch(e){case 0:var n=IORAM[19]+((IORAM[20]&7)<<8);AudioEngine[e].frequency=audioSampleRate/(524288/((2048-n)*4));break;case 1:var n=IORAM[24]+((IORAM[25]&7)<<8);AudioEngine[e].frequency=audioSampleRate/(524288/((2048-n)*4));break;case 2:var n=IORAM[29]+((IORAM[30]&7)<<8);AudioEngine[e].frequency=4194304/((2048-n)*2)/audioSampleRate;break}}function readDMGPalette(e){var n=IORAM[71+e];return colours[n&3].concat(colours[n>>2&3],colours[n>>4&3],colours[n>>6&3])}function drawScanline(e){var n=IORAM[64];if(n&128){tileLayerData.set(emptyTileLayer),CGB&&tileLayerPalette.set(emptyTileLayer);var t=[];if(n&1||CGB){var r=IORAM[67],s=7-r%8,f=(r>>3)%32;f<0&&(f+=32);var R=e+IORAM[66]&255,A=R%8*2,x=(R>>3)*32,u=6144+(n>>3&1)*1024+x,F=4096-(n>>4&1)*4096;if(CGB){var o=VRAM[u+f+8192],g=o&7,M=o&64,I=o&32?1:-1;I==1&&(s=7-s)}else{var M=!1;I=-1}var c=VRAM[u+f];!(n&16)&&c>127&&(c-=256);var l=F+c*16+(M?14-A:A);CGB&&o&8&&(l+=8192);var C=VRAM[l],S=VRAM[l+1],d;for(a=0;a<160;a++)d=(C>>s&1)+((S>>s&1)<<1),tileLayerData[a]=d,CGB&&(tileLayerPalette[a]=g|o&128),s+=I,s&8&&(f=(f+1)%32,c=VRAM[u+f],CGB?(o=VRAM[u+f+8192],g=o&7,M=o&64,I=o&32?1:-1,I==1?s=0:s=7):s=7,!(n&16)&&c>127&&(c-=256),l=F+c*16+(M?14-A:A),CGB&&o&8&&(l+=8192),C=VRAM[l],S=VRAM[l+1])}else for(a=0;a<160;a++)tileLayerData[a]=0,CGB&&(tileLayerPalette[a]=0);if(n&32){var R=e-IORAM[74];if(R>=0&&R<144){var r=7-IORAM[75],s=7-(r&7),f=Math.floor(r/8),A=R%8*2,x=(R>>3)*32,u=6144+(n>>6&1)*1024+x,F=4096-(n>>4&1)*4096,c=VRAM[u+f];!(n&16)&&c>127&&(c-=256);var l=F+c*16+A;if(CGB){var o=VRAM[u+f+8192],g=o&7;o&8&&(l+=8192)}var C=VRAM[l],S=VRAM[l+1],d;for(a=0;a<160;a++)if(d=(C>>s&1)+((S>>s&1)<<1),f>-1&&f<21&&(tileLayerData[a]=d,CGB&&(tileLayerPalette[a]=g|o&128)),--s<0){if(s=7,f=f+1,c=VRAM[u+f],!(n&16)&&c>127&&(c-=256),l=F+c*16+A,CGB){var o=VRAM[u+f+8192],g=o&7;o&8&&(l+=8192)}C=VRAM[l],S=VRAM[l+1]}}}for(var B=e*160,d,P=CGB?CGBInt32BG:palettesInt32,a=0;a<160;a++)d=tileLayerData[a],d!=0||GBScreenInt32[B]==0?(CGB&&(d+=(tileLayerPalette[a]&7)*4),GBScreenInt32[B++]=P[d]):B++;if(n&2)for(var O=156,a=0;a<40;a++)drawSprite(O,e,palettesInt32),O-=4}else{var B=e*160*4;if(CGB)var E=255,v=255,y=255;else var E=colours[0][0],v=colours[0][1],y=colours[0][2];for(var a=0;a<160;a++)GBScreen.data[B++]=E,GBScreen.data[B++]=v,GBScreen.data[B++]=y,GBScreen.data[B++]=255}}function drawSprite(e,n,t){var r,s=n-(OAM[e]-16),f=n*160,R=OAM[e+3]&128,A=IORAM[64]&4;if(s>=0&&(A?16:8)>s){var x=OAM[e+3];if(CGB)var t=CGBInt32Spr,u=(x&7)*4;else var u=(((x&16)>>4)+1)*4;x&64&&(s=(A?15:7)-s);var F=OAM[e+2];A&&(F&=65534);var o=F*16+s*2,g=0;if(x&32){var M=OAM[e+1]-8;r=1}else{var M=OAM[e+1]-1;r=-1}var I=f+M;CGB&&x&8&&(o+=8192);for(var c=VRAM[o],l=VRAM[o+1],C;g<8;)M>=0&&M<160&&(C=(c>>g&1)+((l>>g&1)<<1),C!=0&&(!(tileLayerPalette[M]&128||R)||tileLayerData[M]==0)&&(C+=u,GBScreenInt32[I]=t[C])),M+=r,I+=r,g++}}function prepareGBScreen(){GBScreen.data.set(EmptyImageBuffer)}var MBCTable=[{type:0,hardware:[]},{type:1,hardware:[],RAMBankMode:!1},{type:1,hardware:["RAM"],RAMBankMode:!1},{type:1,hardware:["RAM","BATTERY"],RAMBankMode:!1},null,{type:2,hardware:[]},{type:2,hardware:["BATTERY"]},null,{type:0,hardware:["RAM"]},{type:0,hardware:["RAM","BATTERY"]},null,{type:6,hardware:[]},{type:6,hardware:["RAM"]},{type:6,hardware:["RAM","BATTERY"]},null,{type:3,hardware:["TIMER","BATTERY"]},{type:3,hardware:["TIMER","RAM","BATTERY"]},{type:3,hardware:[]},{type:3,hardware:["RAM"]},{type:3,hardware:["RAM","BATTERY"]},null,{type:4,hardware:[]},{type:4,hardware:["RAM"]},{type:4,hardware:["RAM","BATTERY"]},null,{type:5,hardware:[]},{type:5,hardware:["RAM"]},{type:5,hardware:["RAM","BATTERY"]},{type:5,hardware:["RUMBLE"]},{type:5,hardware:["RUMBLE","RAM"]},{type:5,hardware:["RUMBLE","RAM","BATTERY"]}],MBCWriteHandlers=[],MBCReadHandlers=[];MBCWriteHandlers[0]=function(e,n){},MBCWriteHandlers[1]=function(e,n){e<8192?MBC.RAMenable=(n&15)==10:e<16384?(n&31||(n=1),MBC.ROMbank=MBC.ROMbank&96|n&31):e<24576?MBC.RAMBankMode?MBC.RAMbank=n&3:MBC.ROMbank=MBC.ROMbank&31|(n&3)<<5:e<32768?MBC.RAMBankMode=n&1:e<49152&&e>=40960&&MBC.RAMenable&&(CRAM[e-40960+MBC.RAMbank*8192]=n)},MBCWriteHandlers[3]=function(e,n){e<8192?(MBC.RAMenable=(n&15)==10,MBC.RAMenable||(MBC.RAMbank=0)):e<16384?MBC.ROMbank=Math.max(n&127,1):e<24576?(n<4||n>7&&n<13)&&(MBC.RAMbank=n):e<32768?MBC.hardware.indexOf("TIMER")>-1&&(!MBC.RTC.latch&&n==1&&updateRTC(!0),MBC.RTC.latch=n==1):e<49152&&e>=40960&&MBC.RAMenable&&MBC.RAMbank<4&&(CRAM[e-40960+MBC.RAMbank*8192]=n)};function updateRTC(e){var n=new Date;MBC.RTC.seconds=n.getSeconds(),MBC.RTC.minutes=n.getMinutes(),MBC.RTC.hours=(n.getHours()+14)%24,MBC.RTC.lowDays=Math.floor(n.getTime()/(1e3*60*60*24))&255,MBC.RTC.hiDays=(Math.floor(n.getTime()/(1e3*60*60*24))&256)>>8}MBCWriteHandlers[5]=function(e,n){e<8192?MBC.RAMenable=(n&15)==10:e<12288?MBC.ROMbank=MBC.ROMbank&256|n:e<16384?MBC.ROMbank=MBC.ROMbank&255|(n&1)<<8:e<24576?MBC.RAMbank=n&15:e<49152&&e>=40960&&MBC.RAMenable&&(CRAM[e-40960+MBC.RAMbank*8192]=n)},MBCReadHandlers[0]=function(e){return e<16384||e<32768?game[e]:0},MBCReadHandlers[1]=function(e){return e<16384?game[e]:e<32768?game[e-16384+MBC.ROMbank*16384]:e<49152&&e>=40960&&MBC.RAMenable?CRAM[e-40960+MBC.RAMbank*8192]:0},MBCReadHandlers[3]=function(e){if(e<16384)return game[e];if(e<32768)return game[e-16384+MBC.ROMbank*16384];if(e<49152&&e>=40960)if(MBC.RAMenable){if(MBC.RAMbank<4)return CRAM[e-40960+MBC.RAMbank*8192];if(MBC.RAMbank==8)return MBC.RTC.seconds;if(MBC.RAMbank==9)return MBC.RTC.minutes;if(MBC.RAMbank==10)return MBC.RTC.hours;if(MBC.RAMbank==11)return MBC.RTC.lowDays;if(MBC.RAMbank==11)return MBC.RTC.hiDays|(MBC.RTC.active?0:64)|(MBC.RTC.dayCarry?128:0)}else return 0;else return 0},MBCReadHandlers[5]=function(e){return e<16384?game[e]:e<32768?game[e-16384+MBC.ROMbank*16384]:e<49152&&e>=40960&&MBC.RAMenable?CRAM[e-40960+MBC.RAMbank*8192]:0},MBCWriteHandlers[6]=function(e,n){e<16384&&e>=8192?MBC.ROMbank=n:e<49152&&e>=40960&&(CRAM[e-40960]=n)},MBCReadHandlers[6]=function(e){return e<16384?e-MBC.offset<0?MBC.lowData[e]|0:game[e-MBC.offset+112]:e<32768?game[e-16384+MBC.ROMbank*16384-MBC.offset+112]:e<49152&&e>=40960?CRAM[e-40960]:0};function loadBattery(){var e=localStorage["battery/"+ROMID];if(MBC.type==5?CRAM=new Uint8Array(RAMsizesMBC5[Math.min(3,game[329])]):CRAM=new Uint8Array(RAMsizes[Math.min(3,game[329])]),typeof e<"u")for(var n=0;n<e.length;n++)CRAM[n]=e.charCodeAt(n)}function saveBattery(){if(MBC&&MBC.hardware.indexOf("BATTERY")!=-1){for(var e="",n=0;n<CRAM.length;n++)e+=String.fromCharCode(CRAM[n]);localStorage["battery/"+ROMID]=e}}function init(){typeof GBObj.onload=="function"&&GBObj.onload(GBObj),GBObj.onload=null,GBObj.ROMname=getROMName(),GBMaster.gameboys.indexOf(GBObj)==-1&&GBMaster.gameboys.push(GBObj),GBObj.cycle=cycle,GBObj.frameCycles=0;for(var e=0;e<128;e++)IOReadFunctions[e]==null&&(IOReadFunctions[e]=IOReadDefault),IOWriteFunctions[e]==null&&(IOWriteFunctions[e]=IOWriteDefault);ROMID=generateUniqueName(),CGB=game[323]==128||game[323]==192,buttonByte=255,reset(!0)}var RAMsizes=[0,2048,8192,32768],RAMsizesMBC5=[0,8192,32768,131072];this.reset=reset;function reset(e){registerDebug=[],instCount=0,prepareAudioEngine(),tileLayerPalette.set(emptyTileLayer);var n=MBCTable[game[327]]!=null?game[327]:0;if(MBC=JSON.parse(JSON.stringify(MBCTable[n])),GBObj.MBC=MBC,MBC.hardware.indexOf("RAM")>-1&&(MBC.RAMenable=!1,MBC.RAMbank=0,e&&(MBC.hardware.indexOf("BATTERY")>-1?loadBattery():MBC.type==5?CRAM=new Uint8Array(RAMsizesMBC5[Math.min(3,game[329])]):CRAM=new Uint8Array(RAMsizes[Math.min(3,game[329])])),MBC.hardware.indexOf("TIMER")>-1&&(MBC.RTC={latch:!1,seconds:0,minutes:0,hours:0,lowDays:0,hiDays:0,active:!1,dayCarry:!1,setCycle:0,setTime:0})),MBC.type>0&&(MBC.ROMbank=1),MBCReadHandler=MBCReadHandlers[MBC.type],MBCWriteHandler=MBCWriteHandlers[MBC.type],VRAM=new Uint8Array(CGB?16384:8192),RAM=new Uint8Array(CGB?32768:8192),OAM=new Uint8Array(160),IORAM=new Uint8Array(128),ZRAM=new Uint8Array(128),CPUSpeed=1,CGB){IORAM[112]=1,CGBBGPalReg=new Uint8Array(96),CGBBGPal=new Uint8Array(128),CGBSprPalReg=new Uint8Array(96),CGBSprPal=new Uint8Array(128),CGBInt32BG=new Uint32Array(CGBBGPal.buffer),CGBInt32Spr=new Uint32Array(CGBSprPal.buffer);for(var t=0,r=0;r<32;r++)CGBBGPal.set([255,255,255,255],r*4),CGBSprPal.set([255,255,255,255],r*4),CGBSprPalReg[t]=255,CGBBGPalReg[t++]=255,CGBSprPalReg[t]=127,CGBBGPalReg[t++]=127;CGBDMA={active:!1,mode:0,Tlength:0,srcPos:0,destPos:0},biosActive=CGBbios!=null}else CGBDMA={active:!1},biosActive=bios!=null,biosActive||(IORAM[112]=1);SP=0,biosActive?registers=new Uint8Array([0,0,0,0,0,0,0]):(SP=65534,registers=new Uint8Array([CGB?17:1,0,19,0,216,1,77]),IORAM[64]=145),flags=[0,0,0,0,1],PC=biosActive?0:256,IORAM[68]=biosActive?0:CGB?144:153,Cycles=0,LCDstate=biosActive?1:2,IME=!1,halted=!1,palettes=new Uint8Array(readDMGPalette(0).concat(readDMGPalette(1),readDMGPalette(2))),palettesInt32=new Uint32Array(palettes.buffer),masterClock=0,lineCycles=0,soundCycles=0,soundPhase=0,timerCycles=0,audioCycles=0,cyclesForSample=4194304/audioSampleRate,divCounts=0,audioSyncFrames=0,timeStart=Date.now(),prepareGBScreen(),typeof GBObj.onstart=="function"&&GBObj.onstart(),GBObj.onstart=null}this.setButtonByte=function(e){buttonByte=e},this.prepareButtonByte=function(){if(buttonByte=(keysArray[keyConfig.DOWN]<<3)+(keysArray[keyConfig.UP]<<2)+(keysArray[keyConfig.LEFT]<<1)+(keysArray[keyConfig.RIGHT]<<0)+(keysArray[keyConfig.START]<<7)+(keysArray[keyConfig.SELECT]<<6)+(keysArray[keyConfig.B]<<5)+(keysArray[keyConfig.A]<<4),getGamepads){if(navigator.getGamepads)var e=navigator.getGamepads();for(var n=0;n<e.length;n++)if(e[n]!=null){var t=e[n];(t.axes[0]>.5||t.buttons[15].pressed)&&(buttonByte^=1),(t.axes[0]<-.5||t.buttons[14].pressed)&&(buttonByte^=2),(t.axes[1]>.5||t.buttons[13].pressed)&&(buttonByte^=8),(t.axes[1]<-.5||t.buttons[12].pressed)&&(buttonByte^=4),t.buttons[9].pressed&&(buttonByte^=128),t.buttons[8].pressed&&(buttonByte^=64),t.buttons[0].pressed&&(buttonByte^=32),t.buttons[1].pressed&&(buttonByte^=16)}}},this.audioSyncUpdate=function(){try{if(GBObj.paused)return;GBObj.options.cButByte||GBObj.prepareButtonByte(),NoAudioAPI&&audioSyncFrames++,frameskip=!1;for(var e=audioSyncFrames>=1,n=Date.now();e||audioSyncFrames>=2;){for(e=!1;GBObj.frameCycles<70224;)cycle();if(GBObj.frameCycles-=70224,audioSyncFrames--,Date.now()-n>16){audioSyncFrames=1;break}frameskip=!0}}catch(t){console.error(t.stack),errorScreen(t)}};function errorScreen(e){GBObj.paused=!0,internalCtx.fillStyle="#FFFFFF",internalCtx.fillRect(0,0,160,144);var n=new Image;n.src=sadGB,n.onload=function(){internalCtx.drawImage(n,68,51),ctx.drawImage(internalCanvas,0,0,canvas.width,canvas.height),console.error(`Something went horribly wrong! Here's the stack trace:
`+e.stack)}}function drawProgress(e){var n=["#B90546","#5255A5","#79AD36","#DDB10A","#009489"];internalCtx.fillStyle="#FFFFFF",internalCtx.fillRect(0,0,160,144),internalCtx.fillStyle="#EEEEEE",internalCtx.fillRect(30,71,100,2);for(var t=e.loaded/e.total,r=0;r<5;r++){var s=Math.min(.2,t-r*.2);s>0&&(internalCtx.fillStyle=n[r],internalCtx.fillRect(30+r*20,71,s*100,2))}internalCtx.fillStyle="rgba(0, 0, 0, 0.2)",internalCtx.fillRect(30,71,100,1),ctx.drawImage(internalCanvas,0,0,canvas.width,canvas.height)}function drawFrame(){frameskip||(internalCtx.putImageData(GBScreen,0,0),ctx.drawImage(internalCanvas,0,0,canvas.width,canvas.height),prepareGBScreen())}function printDebug(){var e="";e+="A: "+registers[0]+"<br>",e+="B: "+registers[1]+"<br>",e+="C: "+registers[2]+"<br>",e+="D: "+registers[3]+"<br>",e+="E: "+registers[4]+"<br>",e+="H: "+registers[5]+"<br>",e+="L: "+registers[6]+"<br>",e+="PC: "+PC+"<br>",e+="SP: "+SP+"<br>",document.getElementById("debug").innerHTML=e}var timerMods=[63,0,3,15];function handleScanCoin(){IORAM[65]|=4,IORAM[65]&64&&(IORAM[15]|=2)}function cycle(){for(masterClock+=Cycles,masterClock-audioCycles>=cyclesForSample&&(audioCycles+=cyclesForSample,squareWaveNode(0),squareWaveNode(1),waveNode(2),noiseNode(3),++AudioEngine.out.bufferPos==bufferSize&&advanceBufWrite(AudioEngine.out));masterClock-timerCycles>=16;)divCounts=divCounts+1&63,timerCycles+=16,divCounts&15||(IORAM[4]=IORAM[4]+1&255),IORAM[7]&4&&!(divCounts&timerMods[IORAM[7]&3])&&(IORAM[5]=IORAM[5]+1&255,IORAM[5]==0&&(IORAM[5]=IORAM[6],IORAM[15]|=4));GBObj.frameCycles+=Cycles/CPUSpeed,lineCycles+=Cycles/CPUSpeed,lineCycles>=456&&(IORAM[68]=(IORAM[68]+1)%154,IORAM[68]==IORAM[69]&&IORAM[64]&128?handleScanCoin():IORAM[65]&=251,lineCycles-=456,IORAM[68]==144?(drawFrame(),LCDstate=1,IORAM[64]&128&&(IORAM[15]|=1,IORAM[65]&16&&(IORAM[15]|=2))):IORAM[68]==0&&(LCDstate=2,IORAM[65]&32&&IORAM[64]&128&&(IORAM[15]|=2))),LCDstate!=1&&(lineCycles<=80?LCDstate!=2&&(LCDstate=2,IORAM[65]&32&&IORAM[64]&128&&(IORAM[15]|=2)):lineCycles<=252?LCDstate!=3&&(LCDstate=3):LCDstate!=0&&(LCDstate=0,CGBDMA.active&&CGBDMA.mode&&CGBDMAStep(16),frameskip||drawScanline(IORAM[68]),IORAM[65]&8&&IORAM[64]&128&&(IORAM[15]|=2))),masterClock-soundCycles>=8192*CPUSpeed&&(soundCycles+=8192*CPUSpeed,IORAM[38]&128&&(soundPhase&1||handleLengths(),soundPhase==7&&handleEnvelope(),soundPhase%4==2&&handleSweep(!0)),soundPhase=soundPhase+1&7);var e=IORAM[15]&ZRAM[127];halted&&e?halted=!1:halted&&(haltSkip(),e=IORAM[15]&ZRAM[127]),IME&&e&&(IME=!1,e&1?(IORAM[15]&=30,RST(64)):e&2?(IORAM[15]&=29,RST(72)):e&4?(IORAM[15]&=27,RST(80)):e&8?(IORAM[15]&=23,RST(88)):e&16&&(IORAM[15]&=15,RST(96))),Cycles=0,halted?Cycles+=0:CGBDMA.active&&!CGBDMA.mode?(CGBDMAStep(2),Cycles=4*CPUSpeed):Instructions[MemRead(PC++)](),PC&=65535,instCount++}function appendRegistersDebug(){registerDebug.push(registers[0]),registerDebug.push(registers[1]),registerDebug.push(registers[2]),registerDebug.push(registers[3]),registerDebug.push(registers[4]),registerDebug.push(registers[5]),registerDebug.push(registers[6]),registerDebug.push(PC),registerDebug.push(SP)}function CGBDMAStep(e){for(var n=0;n<e;n++)VRAM[IORAM[79]*8192+CGBDMA.destPos++]=MemRead(CGBDMA.srcPos++);CGBDMA.Tlength-=e,(CGBDMA.Tlength<=0||CGBDMA.destPos>=8192)&&(CGBDMA.active=!1)}function MemRead(e){return Cycles+=4,e<256&&biosActive?CGB?CGBbios[e]:bios[e]:e<32768?CGB&&biosActive&&e>=512&&e<2304?CGBbios[e]:MBCReadHandler(e)|0:e<40960?CGB?VRAM[e-32768+8192*IORAM[79]]:VRAM[e-32768]:e<49152?MBCReadHandler(e)|0:e<57344?CGB?e<53248?RAM[e-49152]:RAM[e-53248+4096*IORAM[112]]:RAM[e-49152]:e<65024?CGB?e<61440?RAM[e-57344]:RAM[e-61440+4096*IORAM[112]]:RAM[e-57344]:e<65184?OAM[e-65024]:e<65280?0:e<65408?IOReadFunctions[e-65280](e-65280):ZRAM[e-65408]}function MemWrite(e,n){if(Cycles+=4,e<32768)MBCWriteHandler(e,n);else if(e<40960)CGB?VRAM[e-32768+8192*IORAM[79]]=n:VRAM[e-32768]=n;else if(e<49152)MBCWriteHandler(e,n);else if(e<57344)CGB?e<53248?RAM[e-49152]=n:RAM[e-53248+4096*IORAM[112]]=n:RAM[e-49152]=n;else if(e<65024){console.log("writing to shadow ram?");debugger;CGB?e<61440?RAM[e-57344]=n:RAM[e-61440+4096*IORAM[112]]=n:RAM[e-57344]=n}else e<65184?OAM[e-65024]=n:e<65280||(e<65408?IOWriteFunctions[e-65280](n,e-65280):ZRAM[e-65408]=n)}function haltSkip(){var e=[1/0,1/0,1/0,1/0,1/0],n=1/0;if(IORAM[7]&4){var t=256-IORAM[5]-1;t*=16*(timerMods[IORAM[7]&3]+1),t+=16-(masterClock-timerCycles),t+=16*(timerMods[IORAM[7]&3]-(divCounts&timerMods[IORAM[7]&3])),e[2]=t,ZRAM[127]&4&&t<n&&(n=t)}if(IORAM[64]&128){var r=144-IORAM[68];r<=0&&(r+=154);var t=((r-1)*456+(456-lineCycles))*CPUSpeed;if(e[0]=t,IORAM[65]&16&&(e[1]=t),ZRAM[127]&1&&t<n&&(n=t),IORAM[65]&64){r=IORAM[69]-IORAM[68],r<=0&&(r+=154);var t=((r-1)*456+(456-lineCycles))*CPUSpeed;e[1]>t&&(e[1]=t)}if(IORAM[65]&40){var s=0;if(IORAM[68]>142&&(s=((153-IORAM[68])*456+(456-lineCycles))*CPUSpeed),IORAM[65]&8)if(IORAM[68]>143||IORAM[68]==143&&lineCycles>252){var t=s+252*CPUSpeed;e[1]>t&&(e[1]=t)}else{var t=252-lineCycles;t<=0&&(t+=456),t*=CPUSpeed,e[1]>t&&(e[1]=t)}if(IORAM[65]&32)if(IORAM[68]>143){var t=s;e[1]>t&&(e[1]=t)}else{var t=(456-lineCycles)*CPUSpeed;e[1]>t&&(e[1]=t)}}ZRAM[127]&2&&e[1]<n&&(n=e[1])}var f=(70224-GBObj.frameCycles)*CPUSpeed;for(f<n?n=f:halted=!1,masterClock+=n,lineCycles+=n/CPUSpeed,(LCDstate==2||LCDstate==3)&&lineCycles>252&&(CGBDMA.active&&CGBDMA.mode&&CGBDMAStep(16),frameskip||drawScanline(IORAM[68]));lineCycles>=456;)IORAM[68]=(IORAM[68]+1)%154,lineCycles-=456,IORAM[68]<144&&lineCycles>252?(CGBDMA.active&&CGBDMA.mode&&CGBDMAStep(16),frameskip||drawScanline(IORAM[68])):IORAM[68]==144&&drawFrame();IORAM[68]==IORAM[69]&&IORAM[64]&128?handleScanCoin():IORAM[65]&=251,IORAM[68]<144?lineCycles<=80?LCDstate=2:lineCycles<=252?LCDstate=3:LCDstate=0:LCDstate=1;var R=masterClock-timerCycles>>4;if(IORAM[4]=IORAM[4]+(R>>4)&255,IORAM[7]&4){var A=timerMods[IORAM[7]&3],x=R/(A+1)|0;(R&A)+(divCounts&A)>A&&x++,IORAM[5]=IORAM[6]+(IORAM[5]-IORAM[6]+x)%(256-IORAM[6])}for(divCounts=divCounts+R&63,timerCycles+=16*R;masterClock-soundCycles>=8192*CPUSpeed;){for(;soundCycles-audioCycles>=cyclesForSample;)audioCycles+=cyclesForSample,squareWaveNode(0),squareWaveNode(1),waveNode(2),noiseNode(3),++AudioEngine.out.bufferPos==bufferSize&&advanceBufWrite(AudioEngine.out);soundCycles+=8192*CPUSpeed,IORAM[38]&128&&(soundPhase&1||handleLengths(),soundPhase==7&&handleEnvelope(),soundPhase%4==2&&handleSweep(!0)),soundPhase=soundPhase+1&7}for(;masterClock-audioCycles>=cyclesForSample;)audioCycles+=cyclesForSample,squareWaveNode(0),squareWaveNode(1),waveNode(2),noiseNode(3),++AudioEngine.out.bufferPos==bufferSize&&advanceBufWrite(AudioEngine.out);for(var u=0;u<5;u++)n>=e[u]&&e[u]!=1/0&&(IORAM[15]|=1<<u);return GBObj.frameCycles+=n/CPUSpeed,n}function PrefixCB(){PC&=65535,PrefixCBI[MemRead(PC++)]()}function RLC(e){flags[3]=registers[e]>>7,registers[e]=(registers[e]<<1)+flags[3]&255,flags[0]=registers[e]==0?1:0,flags[1]=0,flags[2]=0}function RRC(e){flags[3]=registers[e]&1,registers[e]=(registers[e]>>1)+(flags[3]<<7)&255,flags[0]=registers[e]==0?1:0,flags[1]=0,flags[2]=0}function RL(e){var n=registers[e]>>7;registers[e]=(registers[e]<<1)+flags[3]&255,flags[3]=n,flags[0]=registers[e]==0?1:0,flags[1]=0,flags[2]=0}function RR(e){var n=registers[e]&1;registers[e]=(registers[e]>>1)+(flags[3]<<7)&255,flags[3]=n,flags[0]=registers[e]==0?1:0,flags[1]=0,flags[2]=0}function SLA(e){flags[3]=registers[e]>>7,registers[e]=registers[e]<<1&255,flags[0]=registers[e]==0?1:0,flags[1]=0,flags[2]=0}function SRA(e){flags[3]=registers[e]&1,registers[e]=(registers[e]>>1)+(registers[e]&128)&255,flags[0]=registers[e]==0?1:0,flags[1]=0,flags[2]=0}function SWAP(e){var n=registers[e]&15;registers[e]=(registers[e]>>4)+(n<<4),flags=[registers[e]==0?1:0,0,0,0,1]}function SRL(e){flags[3]=registers[e]&1,registers[e]=registers[e]>>1&255,flags[0]=registers[e]==0?1:0,flags[1]=0,flags[2]=0}function RLCHL(){var e=(registers[5]<<8)+registers[6],n=MemRead(e);flags[3]=n>>7,n=(n<<1)+flags[3]&255,flags[0]=n==0?1:0,flags[1]=0,flags[2]=0,MemWrite(e,n)}function RRCHL(){var e=(registers[5]<<8)+registers[6],n=MemRead(e);flags[3]=n&1,n=(n>>1)+(flags[3]<<7)&255,flags[0]=n==0?1:0,flags[1]=0,flags[2]=0,MemWrite(e,n)}function RLHL(){var e=(registers[5]<<8)+registers[6],n=MemRead(e),t=n>>7;n=(n<<1)+flags[3]&255,flags[3]=t,flags[0]=n==0?1:0,flags[1]=0,flags[2]=0,MemWrite(e,n)}function RRHL(){var e=(registers[5]<<8)+registers[6],n=MemRead(e),t=n&1;n=(n>>1)+(flags[3]<<7)&255,flags[3]=t,flags[0]=n==0?1:0,flags[1]=0,flags[2]=0,MemWrite(e,n)}function SLAHL(){var e=(registers[5]<<8)+registers[6],n=MemRead(e);flags[3]=n>>7,n=n<<1&255,flags[0]=n==0?1:0,flags[1]=0,flags[2]=0,MemWrite(e,n)}function SRAHL(){var e=(registers[5]<<8)+registers[6],n=MemRead(e);flags[3]=n&1,n=(n>>1)+(n&128)&255,flags[0]=n==0?1:0,flags[1]=0,flags[2]=0,MemWrite(e,n)}function SWAPHL(){var e=(registers[5]<<8)+registers[6],n=MemRead(e),t=n&15;n=(n>>4)+(t<<4),MemWrite(e,n),flags=[n==0?1:0,0,0,0,1]}function SRLHL(){var e=(registers[5]<<8)+registers[6],n=MemRead(e);flags[3]=n&1,n=n>>1&255,flags[0]=n==0?1:0,flags[1]=0,flags[2]=0,MemWrite(e,n)}function BIT(e,n){flags[0]=1-((e==0?registers[n]:registers[n]>>e)&1),flags[1]=0,flags[2]=1}function BITHL(e){var n=MemRead((registers[5]<<8)+registers[6]);flags[0]=1-((e==0?n:n>>e)&1),flags[1]=0,flags[2]=1}function RES(e,n){registers[n]&=255-(1<<e)}function RESHL(e){var n=(registers[5]<<8)+registers[6];MemWrite(n,MemRead(n)&255-(1<<e))}function SET(e,n){registers[n]|=1<<e}function SETHL(e){var n=(registers[5]<<8)+registers[6];MemWrite(n,MemRead(n)|1<<e)}function LD(e,n){registers[e]=registers[n]}function LDFHL(e){registers[e]=MemRead((registers[5]<<8)+registers[6])}function LDTHL(e){MemWrite((registers[5]<<8)+registers[6],registers[e])}function LD_M_A(){PC&=65535;var e=MemRead(PC++);PC&=65535,e+=MemRead(PC++)<<8,MemWrite(e,registers[0])}function LD_A_M(){PC&=65535;var e=MemRead(PC++);PC&=65535,e+=MemRead(PC++)<<8,registers[0]=MemRead(e)}function LD_HL_SPM(){PC&=65535;var e=MemRead(PC++);e>127&&(e-=256);var n=SP+e&65535;flags=[0,0,((SP&15)+(e&15)&16)>>4,((SP&255)+(e&255)&256)>>8,1],registers[5]=n>>8,registers[6]=n&255,Cycles+=4}function LDSPHL(){SP=(registers[5]<<8)+registers[6],Cycles+=4}function LDSP(){PC&=65535;var e=MemRead(PC++);PC&=65535,e+=MemRead(PC++)<<8,MemWrite(e,SP&255),MemWrite(e+1&65535,SP>>8)}function ADDSP(){PC&=65535;var e=MemRead(PC++);e>127&&(e-=256),flags=[0,0,((SP&15)+(e&15)&16)>>4,((SP&255)+(e&255)&256)>>8,1],SP=SP+e&65535,Cycles+=8}function LDH_M_A(){PC&=65535;var e=MemRead(PC++);MemWrite(e+65280,registers[0])}function LDH_A_M(){PC&=65535;var e=MemRead(PC++);registers[0]=MemRead(e+65280)}function LDH_C_A(){MemWrite(registers[2]+65280,registers[0])}function LDH_A_C(){registers[0]=MemRead(registers[2]+65280)}function PUSH(e){StackPush((registers[e]<<8)+registers[e+1]),Cycles+=4}function PUSHAF(){StackPush((registers[0]<<8)+(flags[0]<<7)+(flags[1]<<6)+(flags[2]<<5)+(flags[3]<<4)),Cycles+=4}function POP(e){registers[e]=MemRead(SP+1&65535),registers[e+1]=MemRead(SP),SP=SP+2&65535}function POPAF(){registers[0]=MemRead(SP+1&65535);var e=MemRead(SP);SP=SP+2&65535,flags=[e>>7,e>>6&1,e>>5&1,e>>4&1,1]}function StackPush(e){SP=SP-2&65535,MemWrite(SP,e&255),MemWrite(SP+1&65535,e>>8)}function StackPop(){return SP=SP+2&65535,MemRead(SP-2&65535)+(MemRead(SP-1&65535)<<8)}function DAA(){var e=registers[0];flags[1]==0?((flags[3]==1||e>153)&&(e+=96,flags[3]=1),(flags[2]==1||(e&15)>9)&&(e+=6,flags[2]=0)):(flags[2]==1&&(e-=6),flags[3]==1&&(e-=96)),flags[2]=0,registers[0]=e&255,flags[0]=registers[0]==0?1:0}function CPL(){registers[0]=255-registers[0],flags[1]=1,flags[2]=1}function SCF(){flags[3]=1,flags[1]=0,flags[2]=0}function CCF(){flags[3]=1-flags[3],flags[1]=0,flags[2]=0}function ADD(e){var n=registers[0]+registers[e];flags[2]=(registers[0]&15)+(registers[e]&15)>>4,flags[3]=n>>8,registers[0]=n&255,flags[0]=registers[0]==0?1:0,flags[1]=0}function ADDHL(){var e=MemRead((registers[5]<<8)+registers[6]),n=registers[0]+e;flags[2]=(registers[0]&15)+(e&15)>>4,flags[3]=n>>8,registers[0]=n&255,flags[0]=registers[0]==0?1:0,flags[1]=0}function ADDM(){PC&=65535;var e=MemRead(PC++),n=registers[0]+e;flags[2]=(registers[0]&15)+(e&15)>>4,flags[3]=n>>8,registers[0]=n&255,flags[0]=registers[0]==0?1:0,flags[1]=0}function ADC(e){var n=registers[0]+registers[e]+flags[3];flags[2]=(registers[0]&15)+(registers[e]&15)+flags[3]>>4,flags[3]=n>>8,registers[0]=n&255,flags[0]=registers[0]==0?1:0,flags[1]=0}function ADCHL(){var e=MemRead((registers[5]<<8)+registers[6]),n=registers[0]+e+flags[3];flags[2]=(registers[0]&15)+(e&15)+flags[3]>>4,flags[3]=n>>8,registers[0]=n&255,flags[0]=registers[0]==0?1:0,flags[1]=0}function ADCM(){PC&=65535;var e=MemRead(PC++),n=registers[0]+e+flags[3];flags[2]=(registers[0]&15)+(e&15)+flags[3]>>4,flags[3]=n>>8,registers[0]=n&255,flags[0]=registers[0]==0?1:0,flags[1]=0}function SUB(e){var n=registers[0]-registers[e];flags[2]=(registers[0]&15)-(registers[e]&15)<0?1:0,flags[3]=n<0?1:0,registers[0]=n&255,flags[0]=registers[0]==0?1:0,flags[1]=1}function SUBHL(){var e=MemRead((registers[5]<<8)+registers[6]),n=registers[0]-e;flags[2]=(registers[0]&15)-(e&15)<0?1:0,flags[3]=n<0?1:0,registers[0]=n&255,flags[0]=registers[0]==0?1:0,flags[1]=1}function SUBM(){PC&=65535;var e=MemRead(PC++),n=registers[0]-e;flags[2]=(registers[0]&15)-(e&15)<0?1:0,flags[3]=n<0?1:0,registers[0]=n&255,flags[0]=registers[0]==0?1:0,flags[1]=1}function SBC(e){var n=registers[0]-registers[e]-flags[3];flags[2]=(registers[0]&15)-(registers[e]&15)-flags[3]<0?1:0,flags[3]=n<0?1:0,registers[0]=n&255,flags[0]=registers[0]==0?1:0,flags[1]=1}function SBCHL(){var e=MemRead((registers[5]<<8)+registers[6]),n=registers[0]-e-flags[3];flags[2]=(registers[0]&15)-(e&15)-flags[3]<0?1:0,flags[3]=n<0?1:0,registers[0]=n&255,flags[0]=registers[0]==0?1:0,flags[1]=1}function SBCM(){PC&=65535;var e=MemRead(PC++),n=registers[0]-e-flags[3];flags[2]=(registers[0]&15)-(e&15)-flags[3]<0?1:0,flags[3]=n<0?1:0,registers[0]=n&255,flags[0]=registers[0]==0?1:0,flags[1]=1}function AND(e){registers[0]&=registers[e],flags=[registers[0]==0?1:0,0,1,0,1]}function ANDHL(){registers[0]&=MemRead((registers[5]<<8)+registers[6]),flags=[registers[0]==0?1:0,0,1,0,1]}function ANDM(){PC&=65535,registers[0]&=MemRead(PC++),flags=[registers[0]==0?1:0,0,1,0,1]}function XOR(e){registers[0]^=registers[e],flags=[registers[0]==0?1:0,0,0,0,1]}function XORHL(){registers[0]^=MemRead((registers[5]<<8)+registers[6]),flags=[registers[0]==0?1:0,0,0,0,1]}function XORM(){PC&=65535,registers[0]^=MemRead(PC++),flags=[registers[0]==0?1:0,0,0,0,1]}function OR(e){registers[0]|=registers[e],flags=[registers[0]==0?1:0,0,0,0,1]}function ORHL(){registers[0]|=MemRead((registers[5]<<8)+registers[6]),flags=[registers[0]==0?1:0,0,0,0,1]}function ORM(){PC&=65535,registers[0]|=MemRead(PC++),flags=[registers[0]==0?1:0,0,0,0,1]}function CP(e){var n=registers[0]-registers[e];flags=[n&255?0:1,1,(registers[0]&15)-(registers[e]&15)<0?1:0,n<0?1:0,1]}function CPHL(){var e=MemRead((registers[5]<<8)+registers[6]),n=registers[0]-e;flags=[n&255?0:1,1,(registers[0]&15)-(e&15)<0?1:0,n<0?1:0,1]}function CPM(){PC&=65535;var e=MemRead(PC++),n=registers[0]-e;flags=[n&255?0:1,1,(registers[0]&15)-(e&15)<0?1:0,n<0?1:0,1]}function CHL(e){var n=(registers[5]<<8)+registers[6];n=n+e&65535,registers[5]=n>>8,registers[6]=n&255}function NOP(){}function STOP(){CGB&&IORAM[77]&1&&(CPUSpeed==1?(CPUSpeed=2,console.log("doublespeed!")):(CPUSpeed=1,console.log("singlespeed!")),cyclesForSample=4194304*CPUSpeed/audioSampleRate,IORAM[77]=0)}function HALT(){halted=!0}function UNIMP(){}function EI(){IME=!0}function DI(){IME=!1}function RST(e){PC&=65535,StackPush(PC),PC=e+(e<64?GBObj.RSToff:0),Cycles+=4}function JR(e,n){if(Cycles+=4,flags[e]==n){PC&=65535;var t=MemRead(PC++);t>127&&(t-=256),PC=PC+t&65535}else PC=PC+1&65535}function JP(e,n){if(flags[e]==n){var t=PC;PC&=65535;var r=MemRead(PC++);PC&=65535,PC=r+(MemRead(PC++)<<8),Cycles+=4}else PC=PC+2&65535,Cycles+=8}function JPHL(){PC=(registers[5]<<8)+registers[6]}function CALL(e,n){if(flags[e]==n){PC&=65535,StackPush(PC+2&65535);var t=MemRead(PC++);PC&=65535,PC=t+(MemRead(PC++)<<8),Cycles+=4}else PC=PC+2&65535,Cycles+=8}function NRET(){PC=StackPop(),Cycles+=4}function RET(e,n){flags[e]==n?(PC=StackPop(),Cycles+=8):Cycles+=4}function LDMA(e){MemWrite((registers[e]<<8)+registers[e+1],registers[0])}function LDAM(e){registers[0]=MemRead((registers[e]<<8)+registers[e+1])}function LD16M(e){PC&=65535,registers[e+1]=MemRead(PC++),PC&=65535,registers[e]=MemRead(PC++)}function LDSPM(){PC&=65535;var e=MemRead(PC++);PC&=65535,e+=MemRead(PC++)<<8,SP=e}function INC16(e){var n=(registers[e]<<8)+registers[e+1];n=n+1&65535,registers[e]=n>>8,registers[e+1]=n&255,Cycles+=4}function INCSP(){SP=SP+1&65535,Cycles+=4}function DEC16(e){var n=(registers[e]<<8)+registers[e+1];n=n-1&65535,registers[e]=n>>8,registers[e+1]=n&255,Cycles+=4}function DECSP(){SP=SP-1&65535,Cycles+=4}function INC(e){flags[2]=(registers[e]&15)+1>>4,registers[e]=registers[e]+1&255,flags[0]=registers[e]==0?1:0,flags[1]=0}function INCHL(){var e=(registers[5]<<8)+registers[6],n=MemRead(e);MemWrite(e,n+1&255),flags[0]=n+1&255?0:1,flags[1]=0,flags[2]=(n&15)+1>>4}function DEC(e){flags[2]=(registers[e]&15)-1<0?1:0,registers[e]=registers[e]-1&255,flags[0]=registers[e]==0?1:0,flags[1]=1}function DECHL(){var e=(registers[5]<<8)+registers[6],n=MemRead(e);MemWrite(e,n-1&255),flags[0]=n-1&255?0:1,flags[1]=1,flags[2]=(n&15)-1<0?1:0}function LDM(e){PC&=65535,registers[e]=MemRead(PC++)}function LDHLM(){PC&=65535,MemWrite((registers[5]<<8)+registers[6],MemRead(PC++))}function ADDHLSP(){var e=(registers[5]<<8)+registers[6];flags[3]=e+SP>>16,flags[2]=(e&4095)+(SP&4095)>>12,e=e+SP&65535,flags[1]=0,registers[5]=e>>8,registers[6]=e&255,Cycles+=4}function ADDHL16(e){var n=(registers[5]<<8)+registers[6],t=(registers[e]<<8)+registers[e+1];flags[3]=n+t>>16,flags[2]=(n&4095)+(t&4095)>>12,n=n+t&65535,flags[1]=0,registers[5]=n>>8,registers[6]=n&255,Cycles+=4}};
